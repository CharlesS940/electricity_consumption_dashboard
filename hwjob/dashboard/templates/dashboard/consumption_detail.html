{% extends 'dashboard/base.html' %}
{% load static %}

{% block css %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'dashboard/css/dashboard.css' %}">
{% endblock %}

{% block body %}
<main class="consumption-detail-container">
    <h1>Electricity Consumption Details for {{ client.full_name }} (Client ID: {{ client.pk }})</h1>
    <div class="dashboard-flex">
        <div class="table-container">
            <h2>kWh Consumption over last 12 months</h2>
            <table>
                <thead>
                    <tr>
                        <th>Year</th>
                        <th>Month</th>
                        <th>Consumption (kWh)</th>
                        <th>Health Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for c in consumptions|slice:"::-1" %}
                    <tr>
                        <td>{{ c.year }}</td>
                        <td>{{ c.month_name }}</td>
                        <td>{{ c.kwh_consumed }}</td>
                        <td>
                            {% if c.has_anomaly %}
                                <span style="color: red;">Anomaly</span>
                            {% else %}
                                <span style="color: green;">Normal</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <h2>Anomaly History</h2>
            <table>
                <thead>
                    <tr>
                        <th>Year</th>
                        <th>Month</th>
                        <th>Consumption (kWh)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for a in anomalies %}
                    <tr>
                        <td>{{ a.year }}</td>
                        <td>{{ a.month_name }}</td>
                        <td>{{ a.kwh_consumed }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="3">No anomalies found.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="chart-container">
            <h2>
                Consumption Chart:
                <span style="vertical-align: middle;">
                    {% if has_electric_heating %}
                        Electric Heating <i class="icon fill-yellow" data-eva="flash" style="vertical-align:middle; display:inline;"></i>
                    {% else %}
                        No Electric Heating <i class="icon fill-gray" data-eva="flash-off" style="vertical-align:middle; display:inline;"></i>
                    {% endif %}
                </span>
            </h2>
            <div style="text-align: center; margin-bottom: 1em;">
                <span style="display:inline-block;width:16px;height:16px;background:red;"></span>
                Anomaly
                <span style="display:inline-block;width:16px;height:16px;background:blue;"></span>
                Normal
            </div>
            <canvas id="consumptionChart" width="400" height="300"></canvas>
        </div>
    </div>
</main>
{% endblock %}

{% block script %}
    <!-- Chart.js from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Prepare data for the chart
        const labels = [{% for c in consumptions %}'{{ c.month }} / {{ c.year }}'{% if not forloop.last %}, {% endif %}{% endfor %}];
        const data = [{% for c in consumptions %}{{ c.kwh_consumed}}{% if not forloop.last %}, {% endif %}{% endfor %}];
        const pointColors = [{% for c in consumptions %}{% if c.has_anomaly %}'red'{% else %}'blue'{% endif %}{% if not forloop.last %}, {% endif %}{% endfor %}];

        const ctx = document.getElementById('consumptionChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Consumption (kWh)',
                    data: data,
                    borderColor: 'blue',
                    fill: false,
                    pointBackgroundColor: pointColors,
                    pointRadius: 8,
                    pointBorderWidth: 0,
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: { title: { display: true, text: 'Month / Year' , font: { size: 20 }}, ticks: {font: { size: 16 }}},
                    y: { title: { display: true, text: 'Consumption (kWh)', font: { size: 20 } }, ticks: {font: { size: 16 }}},
                },
                plugins: {
                    legend: {
                        display: false
                    }
                },
            }
        });
    </script>
{% endblock %}